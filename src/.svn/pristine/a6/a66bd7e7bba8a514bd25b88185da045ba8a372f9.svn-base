/**
 * ServerThread class for the Server of the minigame game. Takes an incoming connection and creates a new thread.
 *
 * @author Connor Wilkes
 * @version 1/3/2018
 */

package Server;

import Login.ServerRequests;
import Login.User;

import java.io.*;
import java.net.Socket;
import java.util.Date;
import java.util.List;
import java.util.concurrent.Callable;
import java.util.logging.Level;
import java.util.logging.Logger;


public class ServerThread implements Callable<Void> {

    private Socket connection;
    private Server server;
    private User connectedUser;
    private InputStream in;
    private OutputStream out;
    private final static Logger auditLogger = Logger.getLogger("requests");
    private final static Logger errorLogger = Logger.getLogger("errors");

    /**
     * Constructor for testing purposes
     *
     * @param connection Socket associated with the Thread
     */
    public ServerThread(Socket connection) {
        this.connection = connection;
    }

    /**
     * Constructor for the ServerThread class
     *
     * @param connection    Socket associated with the Thread
     * @param server        server associated with this thread
     */
    public ServerThread(Socket connection, Server server) {
        this.connection = connection;
        this.server = server;
    }

    public Socket getConnection() {
        return connection;
    }

    /**
     * Run method for the thread
     *
     * @return null
     */
    @Override
    public Void call() {
        try {
            auditLogger.info("Connected to: " + connection.getRemoteSocketAddress() + " on " + new Date());
            in = connection.getInputStream();
            out = connection.getOutputStream();
            sendConfirmationOfConnection();
            setUpUser();
            while (in.read() != ServerRequests.quit) {
                processRequests();
            }
        } catch (IOException ex) {
            System.err.println(ex);
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        } finally {
            try {
                connection.close();
            } catch (IOException e) {

            }
        }
        return null;
    }

    /**
     * Sets up the thread
     *
     * @throws IOException            if I/O stream is not set up correctly
     * @throws ClassNotFoundException if User class is not found
     */
    public void setUpUser() throws IOException, ClassNotFoundException {
        ObjectInputStream objectIn = new ObjectInputStream(in);
        this.connectedUser = (User) objectIn.readObject();
    }

    /**
     * Sends a string to the client with confirmation of connection to the server
     *
     * @throws IOException if connection fails
     */
    public void sendConfirmationOfConnection() throws IOException {
        Writer writer = new OutputStreamWriter(out, "ASCII");
        writer = new BufferedWriter(writer);
        writer.write("Connected to server\r\n");
        writer.flush();
    }

    /**
     * Processes network requests
     */
    private void processRequests() {
        try {
            if (in.read() == ServerRequests.createLobby) {
                GameOwner owner = new GameOwner(this);
                GameLobby lobby = new GameLobby("testLobby", "password", owner);
                owner.setGameLobby(lobby);
                server.addLobby(lobby);
                new Thread(lobby).start();
            } else if (in.read() == ServerRequests.joinLobby) {
                joinLobby("testLobby", "password");
            } else if (in.read() == ServerRequests.quit) {
                connection.close();
            } else {
                System.err.println("Not a valid request");
            }
        } catch (IOException ex) {
            errorLogger.log(Level.SEVERE, "could not process request", ex);
        }
    }

    private void joinLobby(String lobbyName, String lobbyPassword) {
        List<GameLobby> allLobbies = server.getLobbies();
        for (GameLobby lobby : allLobbies) {
            if (lobby.getLobbyName().equals(lobbyName) && lobby.getPassword().equals(lobbyPassword)) {
                lobby.addPlayer(new Player(this));
                return;
            }
        }
        System.err.println("No server with that name exists and/or the password is incorrect");
    }

    /**
     * Helper function to close the server
     *
     * @param socket socket to close
     */
    public static void closeSilently(Socket socket) {
        if (socket != null) {
            try {
                socket.close();
            } catch (IOException ex) {
                errorLogger.log(Level.SEVERE, "could not close connection", ex);
            }
        }
    }
}

